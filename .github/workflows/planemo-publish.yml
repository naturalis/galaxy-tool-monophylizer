name: Publish to Galaxy Toolshed

on:
  push:
    tags:
      - 'v*'
      - '[0-9]+.*'

jobs:
  publish:
    name: Publish to Galaxy Toolshed
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Planemo
        run: |
          python -m pip install --upgrade pip
          pip install 'planemo>=0.75'
      
      - name: Create Planemo configuration
        env:
          USER: ${{ secrets.USER }}
          KEY: ${{ secrets.KEY }}
          EMAIL: ${{ secrets.EMAIL }}
          PASS: ${{ secrets.PASS }}
        run: |
          cat > $HOME/.planemo.yml << EOF
          shed_username: ${USER}
          sheds:
            toolshed:
              key: ${KEY}
              email: ${EMAIL}
              password: ${PASS}
          EOF
          chmod 600 $HOME/.planemo.yml
      
      - name: Publish to Toolshed
        run: |
          # Try shed_update first (for existing tools)
          if ! planemo shed_update --shed_target toolshed; then
            echo "Update failed, attempting to create new tool..."
            planemo shed_create --shed_target toolshed
          fi
